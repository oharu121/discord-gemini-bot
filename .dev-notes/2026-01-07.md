# 2026-01-07 - Fixing HF Spaces Deployment

## Issues Encountered and Fixes

### 1. "nothing to commit, working tree clean" Error

**Problem:** The original workflow tried to create a new commit from an already-committed checkout:
```yaml
run: |
  git init
  git branch -M main
  git config user.email "..."
  git config user.name "..."
  git add .
  git commit -m "Deploy from GitHub Actions - ${{ github.sha }}"
  git push --force https://...
```

**Fix:** Simply add HF Spaces as a remote and push the existing branch directly:
```yaml
run: |
  git remote add hf https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
  git push --force hf main
```

### 2. "shallow update not allowed" Error

**Problem:** GitHub Actions' `actions/checkout@v6` creates a shallow clone by default, which HF Spaces rejects.

**Fix:** Add `fetch-depth: 0` to fetch full git history:
```yaml
- uses: actions/checkout@v6
  with:
    fetch-depth: 0
```

### 3. "empty or missing yaml metadata in repo card" Warning

**Problem:** HF Spaces expects YAML frontmatter in README.md for Space configuration.

**Fix:** Add HF Spaces metadata to the top of README.md:
```yaml
---
title: Discord Gemini Bot
emoji: ðŸ¤–
colorFrom: yellow
colorTo: purple
sdk: docker
app_port: 7860
---
```

### 4. README changes not triggering deployment

**Problem:** The workflow only triggered on specific paths, which didn't include README.md.

**Fix:** Add `README.md` to the paths filter:
```yaml
paths:
  - 'src/**'
  - 'pyproject.toml'
  - 'uv.lock'
  - 'Dockerfile'
  - 'README.md'  # Added
  - '.github/workflows/deploy.yml'
```

## Final Working Workflow

```yaml
name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
      - 'README.md'
      - '.github/workflows/deploy.yml'

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Set up Python
        run: uv python install 3.12
      - name: Install dependencies
        run: uv sync --frozen
      - name: Run Pyright
        run: uv run pyright

  deploy:
    needs: typecheck
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Push to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ vars.HF_USERNAME }}
          HF_SPACE_NAME: ${{ vars.HF_SPACE_NAME }}
        run: |
          git remote add hf https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
          git push --force hf main
```

## Required GitHub Configuration

### Secrets
- `HF_TOKEN` - Hugging Face token with write access

### Variables
- `HF_USERNAME` - Your HF username (e.g., `oharu121`)
- `HF_SPACE_NAME` - Your Space name (e.g., `discord-bot`)
