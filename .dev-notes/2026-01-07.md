# 2026-01-07 - Fixing HF Spaces Deployment

## Issues Encountered and Fixes

### 1. "nothing to commit, working tree clean" Error

**Problem:** The original workflow tried to create a new commit from an already-committed checkout:
```yaml
run: |
  git init
  git branch -M main
  git config user.email "..."
  git config user.name "..."
  git add .
  git commit -m "Deploy from GitHub Actions - ${{ github.sha }}"
  git push --force https://...
```

**Fix:** Simply add HF Spaces as a remote and push the existing branch directly:
```yaml
run: |
  git remote add hf https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
  git push --force hf main
```

### 2. "shallow update not allowed" Error

**Problem:** GitHub Actions' `actions/checkout@v6` creates a shallow clone by default, which HF Spaces rejects.

**Fix:** Add `fetch-depth: 0` to fetch full git history:
```yaml
- uses: actions/checkout@v6
  with:
    fetch-depth: 0
```

### 3. "empty or missing yaml metadata in repo card" Warning

**Problem:** HF Spaces expects YAML frontmatter in README.md for Space configuration.

**Fix:** Add HF Spaces metadata to the top of README.md (see issue #5 for final working metadata).

### 5. DNS Error - "Cannot connect to host discord.com:443"

**Problem:** Docker SDK on HF Spaces has networking restrictions that block outbound connections to discord.com:
```
aiohttp.client_exceptions.ClientConnectorDNSError: Cannot connect to host discord.com:443 ssl:default [No address associated with hostname]
```

**Root Cause:** Docker containers on HF Spaces have restricted DNS/networking. The bot could not establish WebSocket connection to Discord gateway.

**Fix:** Switch from Docker SDK to Gradio SDK. Gradio SDK doesn't have these networking restrictions.

#### Working Configuration (Gradio SDK)

**README.md metadata:**
```yaml
---
title: Discord Gemini Bot
emoji: ðŸ¤–
colorFrom: yellow
colorTo: purple
sdk: gradio
sdk_version: 5.33.0
app_file: app.py
python_version: "3.12"
---
```

**Architecture change:**
- Docker SDK: Bot runs as main process, tried to add Gradio alongside
- Gradio SDK: Gradio is the main app, Discord bot runs in background daemon thread

**New files created:**
- `app.py` (root level) - HF Spaces entry point for Gradio SDK
- `requirements.txt` - Dependencies for HF Spaces (separate from pyproject.toml)

**app.py structure:**
```python
import threading
from datetime import datetime
import gradio as gr
from fastapi.responses import PlainTextResponse

# Start Discord bot in background thread
bot_thread = threading.Thread(target=start_discord_bot, daemon=True)
bot_thread.start()

# Gradio interface (main app)
with gr.Blocks(title="Discord Gemini Bot") as demo:
    gr.Markdown("# Discord Gemini Bot")
    status_display = gr.Markdown(get_status)
    refresh_btn = gr.Button("Refresh Status")
    refresh_btn.click(fn=get_status, outputs=status_display)

# Add /healthz endpoint for keep-alive pings
@demo.app.get("/healthz")
def healthz():
    return PlainTextResponse("ok")
```

**Why this works:**
- Gradio SDK has fewer networking restrictions than Docker
- Bot runs in daemon thread, doesn't block Gradio's main thread
- Each thread has its own event loop, no conflicts
- `/healthz` endpoint added via Gradio's underlying FastAPI app

### 4. README changes not triggering deployment

**Problem:** The workflow only triggered on specific paths, which didn't include README.md.

**Fix:** Add `README.md` to the paths filter:
```yaml
paths:
  - 'src/**'
  - 'pyproject.toml'
  - 'uv.lock'
  - 'Dockerfile'
  - 'README.md'  # Added
  - '.github/workflows/deploy.yml'
```

## Final Working Workflow

```yaml
name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
      - 'README.md'
      - '.github/workflows/deploy.yml'

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Set up Python
        run: uv python install 3.12
      - name: Install dependencies
        run: uv sync --frozen
      - name: Run Pyright
        run: uv run pyright

  deploy:
    needs: typecheck
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Push to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ vars.HF_USERNAME }}
          HF_SPACE_NAME: ${{ vars.HF_SPACE_NAME }}
        run: |
          git remote add hf https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
          git push --force hf main
```

## Required GitHub Configuration

### Secrets
- `HF_TOKEN` - Hugging Face token with write access

### Variables
- `HF_USERNAME` - Your HF username (e.g., `oharu121`)
- `HF_SPACE_NAME` - Your Space name (e.g., `discord-bot`)
