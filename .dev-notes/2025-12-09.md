# Dev Notes - 2025-12-09

## Summary

Added type checking with Pyright, fixed all type errors, and modernized type hints to Python 3.10+ syntax.

---

## Type Checking Setup

### Installation

```bash
uv add --dev pyright
```

### Running Type Check

```bash
uv run pyright
```

This is equivalent to `npm run typecheck` in the JavaScript/TypeScript world.

### Configuration

Already had `pyrightconfig.json`:
```json
{
  "venvPath": ".",
  "venv": ".venv"
}
```

---

## Type Errors Fixed

### 1. Optional Types with None Default

**Problem:**
```python
# Wrong - Pyright error: "None" is not assignable to "list"
def foo(data: list = None):
```

**Solution:**
```python
# Correct
def foo(data: list | None = None):
```

### 2. Return Type Mismatch

**Problem:** `response.text` can be `None` but return type is `str`

**File:** `src/ai/client.py:51`

**Fix:**
```python
return response.text or ""
```

### 3. Optional Member Access

**Problem:** Accessing `.image_bytes` on potentially `None` object

**File:** `src/ai/client.py:67`

**Fix:**
```python
# Before
return response.generated_images[0].image.image_bytes

# After
image = response.generated_images[0].image
if image:
    return image.image_bytes
```

### 4. Unknown Attribute Access on Operation

**Problem:** `operation.result` attribute not recognized by type checker

**File:** `src/ai/client.py:95-97`

**Fix:**
```python
# Use getattr for safe access
result = getattr(operation, "result", None)
if result and getattr(result, "generated_videos", None):
    video_result = result.generated_videos[0]
    video = getattr(video_result, "video", None)
    if video:
        return video.video_bytes
```

### 5. Config Values Can Be None

**Problem:** `DISCORD_TOKEN` and `GOOGLE_API_KEY` are `str | None`

**Files:** `src/main.py`, `src/bot/client.py`

**Fix:** Add assertions after validation
```python
if not config.validate_config():
    return

# Token is validated above, assert for type checker
assert config.DISCORD_TOKEN is not None
```

### 6. ClientUser vs User Type Mismatch

**Problem:** `self.user` is `ClientUser | None`, but handler expects `User`

**File:** `src/bot/client.py`, `src/bot/handlers.py`

**Fix:** Update type hints to accept both
```python
bot_user: discord.User | discord.ClientUser
```

---

## Modernized Type Syntax

Since project requires Python 3.12+ (`pyproject.toml`), updated to modern syntax:

### Before (Python 3.9 style)
```python
from typing import Optional, Union

def foo(
    x: Optional[list],
    y: Union[str, int]
) -> Optional[bytes]:
```

### After (Python 3.10+ style)
```python
# No imports needed!

def foo(
    x: list | None,
    y: str | int
) -> bytes | None:
```

### Files Updated
- `src/ai/client.py` - Removed `from typing import Optional`
- `src/bot/handlers.py` - Removed `from typing import Optional, Union`

---

## TypeScript to Python Type Comparison

Quick reference for developers coming from TypeScript:

| TypeScript | Python 3.10+ |
|------------|--------------|
| `string` | `str` |
| `number` | `int` or `float` |
| `boolean` | `bool` |
| `null` | `None` |
| `any` | `Any` |
| `void` | `None` |
| `A \| B` | `A \| B` |
| `A \| null` | `A \| None` |
| `string[]` | `list[str]` |
| `[string, number]` | `tuple[str, int]` |
| `Record<string, number>` | `dict[str, int]` |
| `Set<string>` | `set[str]` |
| `(x: number) => string` | `Callable[[int], str]` |
| `"foo" \| "bar"` | `Literal["foo", "bar"]` |

### Generics Example

```typescript
// TypeScript
function first<T>(arr: T[]): T | undefined {
    return arr[0];
}
```

```python
# Python
from typing import TypeVar

T = TypeVar('T')

def first(arr: list[T]) -> T | None:
    return arr[0] if arr else None
```

---

## Updated pyproject.toml

Added dev dependency group:

```toml
[dependency-groups]
dev = [
    "pyright>=1.1.407",
]
```

---

## Current Type Check Status

```bash
$ uv run pyright
0 errors, 0 warnings, 0 informations
```

---

## Deployment Journey

### Goal

Deploy the Discord bot to a free cloud platform with CI/CD via GitHub Actions.

### Attempt 1: Hugging Face Spaces (Docker SDK)

**Why HF Spaces?**
- Free tier available
- Docker support
- Private spaces (keeps secrets safe)
- Simple GitHub Actions integration

**Implementation:**
1. Created `Dockerfile` with uv package manager
2. Created `.github/workflows/deploy.yml` with Pyright check + HF push
3. Added Gradio status page (`src/app.py`) to keep Space alive
4. Added `keep-alive.gs` (Google Apps Script) for external pings

**Challenges Encountered:**

1. **GitHub Actions "nothing to commit" error**
   - Cause: `actions/checkout` already has `.git`, so `git init` did nothing
   - Fix: Added `rm -rf .git` before `git init --initial-branch=main`

2. **HF Spaces "Missing configuration in README" error**
   - Cause: Missing YAML frontmatter in README.md
   - Fix: Added frontmatter with `title`, `emoji`, `sdk`, `app_port`, etc.

3. **Build error: "Readme file does not exist"**
   - Cause: Dockerfile copied `pyproject.toml` before `README.md`, but `pyproject.toml` has `readme = "README.md"`
   - Fix: Updated `COPY pyproject.toml uv.lock ./` to `COPY pyproject.toml uv.lock README.md ./`

4. **DNS Resolution Failure (BLOCKER)**
   ```
   DNS FAIL: discord.com -> [Errno -5] No address associated with hostname
   DNS OK: generativelanguage.googleapis.com -> 142.251.179.95
   DNS OK: google.com -> 172.253.122.101
   ```
   - HF Spaces blocks outbound connections to Discord
   - Google APIs work fine, but Discord is specifically blocked
   - Tried both Docker SDK and Gradio SDK - same result
   - This is likely an intentional restriction by HF to prevent bot abuse

**Conclusion:** HF Spaces is NOT suitable for Discord bots due to network restrictions.

---

### Attempt 2: Railway (Final Solution)

**Why Railway?**
- Simple Docker deployment (existing Dockerfile works)
- No network restrictions on Discord
- GitHub integration for auto-deploy
- $5 trial credit (30 days)
- After trial: $5/month or $1/month free credit (limited)

**Implementation:**

1. Updated `.github/workflows/deploy.yml` for Railway:
   ```yaml
   - name: Install Railway CLI
     run: npm install -g @railway/cli

   - name: Deploy to Railway
     env:
       RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
     run: railway up --service ${{ vars.RAILWAY_SERVICE }}
   ```

2. Cleaned up HF-specific code:
   - Removed `app.py` (Gradio status page)
   - Removed `src/app.py`
   - Removed `keep-alive.gs`
   - Removed `requirements.txt` (Railway uses Dockerfile)
   - Simplified `src/main.py` (removed Gradio thread)
   - Removed HF frontmatter from README.md

3. Updated `Dockerfile`:
   - Removed `EXPOSE 7860` (not needed for Discord bot)

4. Fixed logging to use stdout:
   ```python
   # src/utils/logging.py
   handler = logging.StreamHandler(sys.stdout)  # Not stderr
   ```
   - Railway shows stderr in red, which was confusing

**Railway Setup Steps:**
1. Create project on railway.app (GitHub login)
2. Deploy from GitHub repo (auto-detects Dockerfile)
3. Add environment variables: `DISCORD_TOKEN`, `GOOGLE_API_KEY`
4. Redeploy to pick up new env vars

**Result:** Bot successfully deployed and running!

```
2025-12-09 07:09:14 - GeminiBot - INFO - Using KeywordRouter
2025-12-09 07:09:14 - discord.gateway - INFO - connected to Gateway
2025-12-09 07:09:17 - GeminiBot - INFO - Logged in as oharu-chatbot#0099
```

---

### Platform Comparison

| Platform | Free Tier | Discord Support | Complexity |
|----------|-----------|-----------------|------------|
| HF Spaces | Free (CPU Basic) | NO (DNS blocked) | Low |
| Railway | $5 trial, then $5/mo | YES | Low |
| Render | 750 hrs/mo (sleeps) | YES | Low |
| Oracle Cloud | Always Free (2 VMs) | YES | High |
| Fly.io | 3 shared VMs | YES | Medium |

---

### Key Learnings

1. **Always test network connectivity early** - We could have saved time by checking DNS resolution first

2. **PaaS platforms may have hidden restrictions** - HF Spaces blocks Discord but not Google APIs

3. **Docker SDK vs Gradio SDK doesn't matter for network** - Both have same restrictions

4. **Logs to stderr appear red in Railway** - Use `StreamHandler(sys.stdout)` for normal appearance

5. **Environment variables need redeploy** - Railway doesn't auto-restart on env var changes

---

### Files Changed for Deployment

| File | Action | Notes |
|------|--------|-------|
| `.github/workflows/deploy.yml` | Modified | HF -> Railway |
| `Dockerfile` | Modified | Removed port exposure |
| `src/main.py` | Modified | Removed HF-specific code |
| `src/utils/logging.py` | Modified | stdout instead of stderr |
| `README.md` | Modified | Removed HF frontmatter |
| `app.py` | Deleted | Gradio status page |
| `src/app.py` | Deleted | Gradio module |
| `keep-alive.gs` | Deleted | No longer needed |
| `requirements.txt` | Deleted | Railway uses Dockerfile |

---

### Current Architecture

```
GitHub (push to main)
    |
    v
GitHub Actions
    |
    +---> Pyright Type Check
    |
    v
Railway CLI (railway up)
    |
    v
Railway (Docker container)
    |
    v
Discord Gateway (WebSocket)
```

---

## Bot Giving Outdated/Incorrect Information

### Problem Observed

The bot was giving incorrect responses:
- Wrong date (said 2024-05-23 instead of 2025-12-09)
- Hallucinated CVE information (made-up details for CVE-2025-55182)
- No awareness of current events

### Root Cause Analysis

In `src/ai/client.py`, `generate_text()` had:
- **No system prompt** - Model doesn't know current date or its role
- **No grounding** - Cannot access real-time information

### How Industry AI Bots Handle This

**For real-time info (weather, news, CVEs):**
- **Tool/Function calling** - Bot detects intent, calls external APIs, synthesizes response
- **Grounding/Search** - Let model access search results (Google Search grounding)
- **RAG** - For domain-specific knowledge bases

**For date awareness:**
- **System prompt** - Almost universally, production bots inject current date/time. Standard practice.

**Industry examples:**
| Product | Approach |
|---------|----------|
| ChatGPT | Function calling for browsing, code execution, images |
| Perplexity | Built entirely around search grounding |
| Claude | Tools for web search, computer use |
| Gemini App | Grounding enabled by default |

---

### Function Calling vs Grounding vs MCP

#### When to Use What

| Approach | Best For | Complexity |
|----------|----------|------------|
| System Prompt | Static context (date, bot personality) | Low |
| Grounding | Real-time info retrieval | Low |
| Function Calling | Structured API calls, multi-step workflows | Medium |
| MCP | Cross-platform tool discovery | High |

#### Function Calling vs MCP

| Aspect | Function Calling | MCP (Model Context Protocol) |
|--------|------------------|------------------------------|
| What it is | AI model requests predefined functions | Protocol for connecting AI to tools |
| Scope | Single model feature | Cross-platform standard (Anthropic) |
| Who defines tools | Developer in API request | MCP servers expose capabilities |
| Adoption | All major models | Growing, mainly Claude ecosystem |

**Analogy:**
- Function calling = REST API calls
- MCP = GraphQL-like discovery + REST

---

### Google Search Grounding

#### How It Works

When grounding is enabled:
1. User query goes to Gemini
2. Gemini uses Google Search to find relevant info
3. Model responds with higher accuracy + citations

#### Cost (Gemini 3)

- **$14 per 1,000 search queries** (billed per query executed)
- Multiple searches in one prompt = multiple charges
- **Free until January 5, 2026**

#### Code Example

```python
from google.genai import types

config = types.GenerateContentConfig(
    system_instruction="You are a helpful assistant...",
    tools=[types.Tool(google_search=types.GoogleSearch())]
)

response = client.models.generate_content(
    model="gemini-3-pro-preview",
    contents=prompt,
    config=config
)
```

---

### Decision: System Prompt + Optional Grounding

**Chosen approach:**
1. **Add system prompt with date** - Solves date problem, zero cost
2. **Add optional grounding** - Via `USE_GROUNDING` env var, for real-time queries

**Why not function calling (yet):**
- Adds complexity (define schemas, handle responses, call external APIs)
- Grounding does real-time info retrieval automatically
- Can add function calling later for specific integrations

---

### Implementation

#### Files Changed

| File | Change |
|------|--------|
| `src/config.py` | Added `USE_GROUNDING` env variable |
| `src/ai/client.py` | Added system instruction + optional grounding |
| `src/utils/__init__.py` | Fixed typo: `setup_logger` â†’ `setup_logging` |
| `.env.example` | Added `USE_GROUNDING=false` |

#### Code Changes

**src/config.py**
```python
# Feature flags
USE_FUNCTION_CALLING = os.getenv("USE_FUNCTION_CALLING", "false").lower() == "true"
USE_GROUNDING = os.getenv("USE_GROUNDING", "false").lower() == "true"
```

**src/ai/client.py**
```python
from datetime import datetime
from src import config

# In generate_text():
gen_config = types.GenerateContentConfig(
    system_instruction=f"""You are a helpful Discord bot assistant.
Today's date is {datetime.now().strftime("%Y-%m-%d")}.
Be concise in your responses as they appear in Discord chat.""",
)

# Add grounding if enabled
if config.USE_GROUNDING:
    gen_config.tools = [types.Tool(google_search=types.GoogleSearch())]
```

#### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `USE_GROUNDING` | `false` | Enable Google Search grounding for real-time info |

To enable grounding in Railway:
1. Go to Railway dashboard > Variables
2. Add `USE_GROUNDING=true`
3. Redeploy

---

### References

- [Google Gen AI SDK](https://googleapis.github.io/python-genai/)
- [Grounding with Google Search](https://ai.google.dev/gemini-api/docs/google-search)
- [Gemini 3 API Updates](https://developers.googleblog.com/new-gemini-api-updates-for-gemini-3/)

---

## References

- Previous notes: .dev-notes/2025-12-07.md (modularization)
- Previous notes: .dev-notes/2025-11-24.md (architecture overview)
- Pyright docs: https://github.com/microsoft/pyright
- Railway docs: https://docs.railway.com
- HF Spaces docs: https://huggingface.co/docs/hub/spaces
