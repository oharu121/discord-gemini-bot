# Dev Notes - 2025-12-09

## Summary

Added type checking with Pyright, fixed all type errors, and modernized type hints to Python 3.10+ syntax.

---

## Type Checking Setup

### Installation

```bash
uv add --dev pyright
```

### Running Type Check

```bash
uv run pyright
```

This is equivalent to `npm run typecheck` in the JavaScript/TypeScript world.

### Configuration

Already had `pyrightconfig.json`:
```json
{
  "venvPath": ".",
  "venv": ".venv"
}
```

---

## Type Errors Fixed

### 1. Optional Types with None Default

**Problem:**
```python
# Wrong - Pyright error: "None" is not assignable to "list"
def foo(data: list = None):
```

**Solution:**
```python
# Correct
def foo(data: list | None = None):
```

### 2. Return Type Mismatch

**Problem:** `response.text` can be `None` but return type is `str`

**File:** `src/ai/client.py:51`

**Fix:**
```python
return response.text or ""
```

### 3. Optional Member Access

**Problem:** Accessing `.image_bytes` on potentially `None` object

**File:** `src/ai/client.py:67`

**Fix:**
```python
# Before
return response.generated_images[0].image.image_bytes

# After
image = response.generated_images[0].image
if image:
    return image.image_bytes
```

### 4. Unknown Attribute Access on Operation

**Problem:** `operation.result` attribute not recognized by type checker

**File:** `src/ai/client.py:95-97`

**Fix:**
```python
# Use getattr for safe access
result = getattr(operation, "result", None)
if result and getattr(result, "generated_videos", None):
    video_result = result.generated_videos[0]
    video = getattr(video_result, "video", None)
    if video:
        return video.video_bytes
```

### 5. Config Values Can Be None

**Problem:** `DISCORD_TOKEN` and `GOOGLE_API_KEY` are `str | None`

**Files:** `src/main.py`, `src/bot/client.py`

**Fix:** Add assertions after validation
```python
if not config.validate_config():
    return

# Token is validated above, assert for type checker
assert config.DISCORD_TOKEN is not None
```

### 6. ClientUser vs User Type Mismatch

**Problem:** `self.user` is `ClientUser | None`, but handler expects `User`

**File:** `src/bot/client.py`, `src/bot/handlers.py`

**Fix:** Update type hints to accept both
```python
bot_user: discord.User | discord.ClientUser
```

---

## Modernized Type Syntax

Since project requires Python 3.12+ (`pyproject.toml`), updated to modern syntax:

### Before (Python 3.9 style)
```python
from typing import Optional, Union

def foo(
    x: Optional[list],
    y: Union[str, int]
) -> Optional[bytes]:
```

### After (Python 3.10+ style)
```python
# No imports needed!

def foo(
    x: list | None,
    y: str | int
) -> bytes | None:
```

### Files Updated
- `src/ai/client.py` - Removed `from typing import Optional`
- `src/bot/handlers.py` - Removed `from typing import Optional, Union`

---

## TypeScript to Python Type Comparison

Quick reference for developers coming from TypeScript:

| TypeScript | Python 3.10+ |
|------------|--------------|
| `string` | `str` |
| `number` | `int` or `float` |
| `boolean` | `bool` |
| `null` | `None` |
| `any` | `Any` |
| `void` | `None` |
| `A \| B` | `A \| B` |
| `A \| null` | `A \| None` |
| `string[]` | `list[str]` |
| `[string, number]` | `tuple[str, int]` |
| `Record<string, number>` | `dict[str, int]` |
| `Set<string>` | `set[str]` |
| `(x: number) => string` | `Callable[[int], str]` |
| `"foo" \| "bar"` | `Literal["foo", "bar"]` |

### Generics Example

```typescript
// TypeScript
function first<T>(arr: T[]): T | undefined {
    return arr[0];
}
```

```python
# Python
from typing import TypeVar

T = TypeVar('T')

def first(arr: list[T]) -> T | None:
    return arr[0] if arr else None
```

---

## Updated pyproject.toml

Added dev dependency group:

```toml
[dependency-groups]
dev = [
    "pyright>=1.1.407",
]
```

---

## Current Type Check Status

```bash
$ uv run pyright
0 errors, 0 warnings, 0 informations
```

---

## References

- Previous notes: .dev-notes/2025-12-07.md (modularization)
- Previous notes: .dev-notes/2025-11-24.md (architecture overview)
- Pyright docs: https://github.com/microsoft/pyright
