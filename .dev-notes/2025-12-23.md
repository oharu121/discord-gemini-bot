# RAG Integration - 2025-12-23

## What Was Implemented

Added `/ask` slash command to query an external RAG (Retrieval-Augmented Generation) backend for knowledge base queries.

## Files Changed

| File | Change |
|------|--------|
| `src/config.py` | Added `RAG_API_URL` env var |
| `src/ai/rag.py` | **New** - `RAGClient` class with SSE streaming support |
| `src/bot/client.py` | Added `/ask` slash command with streaming responses |
| `pyproject.toml` | Added `aiohttp>=3.9.0` dependency |

## How It Works

### User Flow
1. User types `/ask how does X work?` in Discord
2. Bot defers response (shows "thinking...")
3. Bot calls RAG API at `POST /api/chat` with the query
4. RAG API streams back: document chunks, then tokens, then done signal
5. Bot updates Discord message every ~100 characters (streaming effect)
6. Final message includes answer + source citations

### Architecture

```
Discord User
    |
    v
/ask command (client.py)
    |
    v
RAGClient.query() (rag.py)
    |
    v (SSE stream)
RAG Backend (HF Space)
    |
    v
Response with sources back to Discord
```

### Key Implementation Details

**RAGClient (`src/ai/rag.py`)**
- Uses `aiohttp` for async HTTP with SSE streaming
- Parses SSE events: `chunks`, `token`, `done`, `error`
- Yields events as async generator for consumption

**Slash Command (`src/bot/client.py`)**
- Registered via `_register_commands()` method
- Uses `interaction.response.defer()` since RAG takes time
- Updates message incrementally for streaming UX
- Appends source citations at the end

**Source Citations Format**
```
**Sources:**
- `filename.txt:45-120`
- `other.md:10-25`
```

## Configuration

```bash
# Optional - defaults to HF Space
RAG_API_URL=xxx
```

## Design Decisions

1. **Slash commands over prefix** - Discord-native UX, discoverable via autocomplete
2. **Streaming responses** - Better UX than waiting for full response
3. **100 char update threshold** - Balance between responsiveness and rate limits
4. **Top 3 sources** - Keep citations concise, show most relevant
5. **Separate from @mention** - Clear distinction between RAG and normal Gemini chat
