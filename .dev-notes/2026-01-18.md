# 2026-01-18 - Fixing DNS Resolution on HF Spaces (Gradio SDK)

## Problem

After deploying to Hugging Face Spaces with Gradio SDK, the Discord bot failed to connect. The logs showed:

```
logging in using static token
```

But never progressed to "Logged in as..." - the connection hung indefinitely.

## Investigation

### Initial Diagnosis

Added detailed logging to `app.py` to surface the actual error:

```python
logger.info("Attempting login...")
await bot.login(token)
logger.info("Login successful, connecting to gateway...")
await bot.connect()
```

This revealed the real error:

```
ClientConnectorDNSError: Cannot connect to host discord.com:443 ssl:default [No address associated with hostname]
```

### Root Cause

**HF Spaces blocks DNS resolution for external hosts** like `discord.com`. This affects both Docker SDK and Gradio SDK, contrary to earlier assumptions that Gradio SDK had fewer restrictions.

The difference:
- **Docker SDK**: Crashed immediately with DNS error
- **Gradio SDK**: App started but Discord connection silently hung (until we added proper error logging)

## Solution: Custom DNS Resolver

Bypass HF Spaces' restricted DNS by using Google (8.8.8.8) and Cloudflare (1.1.1.1) DNS servers directly via aiohttp's `AsyncResolver`.

### Implementation

#### 1. Add `aiodns` dependency

**requirements.txt:**
```
aiodns>=3.0.0
```

**pyproject.toml:**
```toml
dependencies = [
    "aiodns>=3.0.0",
    # ... other deps
]
```

#### 2. Create async connector factory

**src/bot/client.py:**
```python
async def create_connector_with_custom_dns() -> aiohttp.TCPConnector:
    """Create aiohttp connector with custom DNS resolver (Google/Cloudflare).

    Must be called from within an async context (running event loop).
    """
    try:
        from aiohttp.resolver import AsyncResolver
        resolver = AsyncResolver(nameservers=["8.8.8.8", "1.1.1.1"])
        logger.info("Using custom DNS resolver (Google/Cloudflare)")
        return aiohttp.TCPConnector(resolver=resolver)
    except Exception as e:
        logger.warning(f"Failed to create custom DNS resolver: {e}, using default")
        return aiohttp.TCPConnector()
```

#### 3. Update DiscordBot to accept connector

**src/bot/client.py:**
```python
class DiscordBot(discord.Client):
    def __init__(self, connector: aiohttp.TCPConnector | None = None):
        intents = discord.Intents.all()
        super().__init__(intents=intents, connector=connector)
```

#### 4. Create connector inside async context

**app.py:**
```python
def start_discord_bot() -> None:
    import asyncio
    from src.utils.logging import logger

    async def runner() -> None:
        from src import config
        from src.bot.client import DiscordBot, create_connector_with_custom_dns

        # ... validation ...

        # CRITICAL: Must be created inside async context (running event loop)
        connector = await create_connector_with_custom_dns()
        bot = DiscordBot(connector=connector)

        # ... login and connect ...

    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_until_complete(runner())
```

### Key Insight: Event Loop Timing

The `AsyncResolver` requires a **running** event loop. Several attempts failed:

1. **Creating connector before event loop** - Failed: "no running event loop"
2. **Creating connector after `asyncio.set_event_loop()`** - Failed: loop exists but isn't "running"
3. **Creating connector inside `async def runner()`** - Success: loop is running during `run_until_complete()`

## Successful Deployment Logs

```
Token length: 72, parts: 3
Using custom DNS resolver (Google/Cloudflare)
Using KeywordRouter (keyword-based intent detection)
Starting Discord bot connection...
Attempting login...
logging in using static token
Slash commands synced.
Login successful, connecting to gateway...
Shard ID None has connected to Gateway (Session ID: ...).
Logged in as oharu-chatbot#0099 (ID: 1442420931325722757)
```

## Summary

| Issue | Symptom | Solution |
|-------|---------|----------|
| DNS blocked | `ClientConnectorDNSError: No address associated with hostname` | Use `AsyncResolver` with Google/Cloudflare DNS |
| No running event loop | `RuntimeError: no running event loop` | Create connector inside `async def` function called via `run_until_complete()` |
| Silent failures | Bot hangs with no error | Add explicit logging around `login()` and `connect()` |

## Files Changed

- `app.py` - Restructured to create connector inside async context
- `src/bot/client.py` - Added `create_connector_with_custom_dns()`, updated `DiscordBot.__init__` to accept connector
- `requirements.txt` - Added `aiodns>=3.0.0`
- `pyproject.toml` - Added `aiodns>=3.0.0`
